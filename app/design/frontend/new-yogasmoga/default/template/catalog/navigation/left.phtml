<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Category left navigation
 *
 * @see Mage_Catalog_Block_Navigation
 */
?>
<?php
if (!Mage::registry('current_category'))
    return;

$_categories = $this->getCurrentChildCategories();
$_count = is_array($_categories) ? count($_categories) : $_categories->count();

$parentCategoryId = '';
foreach ($_categories as $category) {
    if ($category->getIsActive()) {
        $path = $category->getPath();
        $parentIds = explode('/', $path);
        $parentCategoryId = $parentIds[2];
        break;
    }
}

/*********** finding out parent category *************/
$currentUrl = Mage::helper('core/url')->getCurrentUrl();
if ($_count == 0) {
    $currentUrl = Mage::helper('core/url')->getCurrentUrl();
    $categoryName = explode('/', $currentUrl);
    $urlKey = $categoryName[3];
    $_category = Mage::getModel('catalog/category')->loadByAttribute('url_key', $urlKey);
    $parentCategoryId = $_category->getId();
}
?>

<div class="leftnav f-left l-align cntn-scroll">
    <ul class="ctglink">
        <?php
        $hasNoSubCategoryHtml = '';
        $withSubCategoryHtml = '';

        $parentCategory = Mage::getModel('catalog/category')->load($parentCategoryId);
        $subSubCategories = $parentCategory->getChildrenCategories();

        foreach ($subSubCategories as $subSubCategory) {

            // do not show category in left Nav if it is not include top navigation
            $showCategoryInLeftNav = Mage::getModel('catalog/category')->load($subSubCategory->getId());
            if ($showCategoryInLeftNav->getIncludeInMenu()) {

                if ($subSubCategory->getChildrenCount() == 0) {

                    $hasNoSubCategoryHtml .= '<li><a href=' . $subSubCategory->getUrl() . ' class="bld ';

                    if ($subSubCategory->getUrl() == $currentUrl)
                        $hasNoSubCategoryHtml .= 'current';

                    $hasNoSubCategoryHtml .= '">' . $subSubCategory->getName() . '</a></li>';
                }
                else {
                    $withSubCategoryHtml .= '<li class = "sub-head"><a href=' . $subSubCategory->getUrl() . ' class="bld ';

                    if ($subSubCategory->getUrl() == $currentUrl)
                        $withSubCategoryHtml .= 'current';

                    $withSubCategoryHtml .= '">' . $subSubCategory->getName() . '</a></li>';
                    $withSubCategoryHtml .= '<ul class = "subnav">';
                    $subSubSubCategory = Mage::getModel('catalog/category')->load($subSubCategory->getId())->getChildrenCategories();

                    foreach ($subSubSubCategory as $child3) {

                        if ($child3->getIsActive()) {
                            $withSubCategoryHtml .= '<li>';

                            //check for current url for h1 tag.......
                            if ($child3->getUrl() == $currentUrl) {
                                $withSubCategoryHtml .= '<h1><a ';
                                $withSubCategoryHtml .= 'class = "current"';
                                $withSubCategoryHtml .= 'href=' . $child3->getUrl() . '>' . $child3->getName() . '</a></h1></li>';
                            }
                            else {
                                $withSubCategoryHtml .= '<a ';
                                $withSubCategoryHtml .= 'href=' . $child3->getUrl() . '>' . $child3->getName() . '</a></li>';
                            }
                        }
                    }
                    $withSubCategoryHtml .= '</ul>';
                }
            }
        }

        // Gift of ys
        $currentUrl = Mage::helper('core/url')->getCurrentUrl();
        $categoryName = explode('/', $currentUrl);
        $urlKey = $categoryName[3];

        echo $hasNoSubCategoryHtml . $withSubCategoryHtml . '</ul></div>';
?>

