<?php
/**
 *
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Template for Mage_Page_Block_Html
 */
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php echo $this->getLang() ?>"
      lang="<?php echo $this->getLang() ?>">
<head>
    <?php
    if ($this->getRequest()->getParam('video') == 'true') {
        ?>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/homepage/video/youtube_fbthumb01.png"/>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/homepage/video/youtube_fbthumb02.png"/>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/homepage/video/youtube_fbthumb03.png"/>
        <meta property="og:title" content="Womens Yoga Clothes - Sweat Wicking Performance | YOGASMOGA"/>
        <meta property="og:description"
              content="YOGASMOGA makes the best womens performance workout clothes for yoga, spin, & running. Advanced Sweat Wicking & Antimicrobial fabric. Free Shipping to US & Canada. "/>
        <?php
    } else {
        ?>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/homepage/main_section/Untitled_Panorama2_c_1.jpg"/>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/homepage/main_section/yogasmoga_mood_2395.jpg"/>
        <meta property="og:image"
              content="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA); ?>wysiwyg/Yogasmoga_op.jpeg"/>
        <meta property="og:title" content="Womens Yoga Clothes - Sweat Wicking Performance | YOGASMOGA"/>
        <meta property="og:description"
              content="YOGASMOGA makes the best womens performance workout clothes for yoga, spin, & running. Advanced Sweat Wicking & Antimicrobial fabric. Free Shipping to US & Canada. "/>
        <?php
    }
    ?>

    <?php echo $this->getChildHtml('head') ?>

    <?php
    //if(Mage::getSingleton('core/session')->getShowVideo())
    if ($this->getRequest()->getParam('video') == 'true') {
        //Mage::getSingleton('core/session')->setShowVideo(false);
        ?>
        <script type="text/javascript">
            var loc = window.location;
            history.replaceState("", document.title, loc.pathname + "breathe");
            jQuery(window).load(function () {
                setTimeout(function () {
                    $j("#hmpagevideo").trigger('click')
                }, 1000);
            });
        </script>
        <?php
    }
    ?>
    <script type="text/javascript">
        jQuery(window).load(function () {
            jQuery("div.showloading").removeClass('showloading');
            setTimeout(function () {
                setfullscreenheight();
            }, 50);

            jQuery("body").on("click", ".vid-popup-overlay", function () {
                var dfVid1 = document.getElementById("vid-1");
                var dfVid2 = document.getElementById("vid-2");
                dfVid1.pause();
                //dfVid2.pause();
            });
            window.onkeyup = function (event) {
                if (event.keyCode == 27) {
                    jQuery(".vid-popup-overlay").trigger("click");
                }
            }
            var bannerImg = document.getElementById("bannerimg").complete;
            if (bannerImg) {
                jQuery(".share-strip, .new-arrivals-block").animate({opacity: 1}, 100);
            }
            jQuery('body').css('overflow', 'auto');
        });
        jQuery(document).ready(function () {
            jQuery('.namaskar-overlay1').fadeOut('slow');
            jQuery(".share-strip, .new-arrivals-block").animate({opacity: 1}, 100);
            setTimeout(function () {
                jQuery("div.page-overlayy").remove();
                jQuery("body").css('overflow', 'auto');
            }, 500);
        });
    </script>
    <div class="namaskar-overlay1">&nbsp;</div>
</head>
<body class="<?php echo $this->getBodyClass() ? $this->getBodyClass() : '' ?>"
      style="margin-right:17px;overflow:hidden;">
<?php echo $this->getChildHtml('after_body_start') ?>
<div class="wrapper">
    <div class="page-overlayy" style="background:#fff; position:fixed; top:0; left:0; right:0; bottom:0; z-index:999;">
        &nbsp;</div>
    <?php echo $this->getChildHtml('global_notices') ?>
    <div class="shopping-cart">


    </div>
    <div class="page">
        <?php echo $this->getChildHtml('header') ?>
        <div id="pagecontainer">
            <h1 style="display: none;"><?php echo Mage::registry('current_category')->getName();?></h1>
            <!-- sliderBanner -->
            <div class="flexslider showloading cat-slide" id="bucket1_slider">
                <ul class="slides">
                    <li  style="background: url('<?php echo Mage::registry('current_category')->getImageUrl() ?>'); background-size: cover;cursor:pointer;"></li>
                </ul>
            </div>
            <!-- sliderBanner -->

            <div class="clear-fix"></div>

            <!-- ProductListing Part -->
            <div class="new_arrivals gridWrap new-arrivals-block" style="width:100%; margin:0 auto; position: relative;">

                <?php $categoryIds = json_decode(trim(Mage::getModel('core/variable')->loadByCode('women_landing_category_ids')->getValue('plain')), true);

                $categoryId_newcollection = $categoryIds['new_collection'];
                $categoryId_quickview = $categoryIds['quick_view'];
                ?>
                <?php
                $newcollection = Mage::getModel('catalog/category')->load($categoryId_newcollection);
                $newarrivals = Mage::getModel('catalog/category')->load($categoryId_quickview);
                ?>

                <div class="shop-col-desc">
                    <div class="new-arrival-heading"><span>NEW ARRIVALS</span></div>
                    <h2>
                        <span class="na-head">TAKE #ONEBREATH IN STYLE</span>
                        <!--<span class="na-link"><a href="<?php echo $newcollection->getUrl(); ?>">Shop New
                                    Collection</a></span>-->
                    </h2>
                    <p class="na-subhead">Our newest styles, prints, patterns, and colors&mdash;<br/>
                        for wherever life takes you.</p>
                </div>
                <?php
                // hide landing page filter
                if(false){ ?>
                    <div class="landing-filter">
                        <!-- Size filter -->
                        <div id="div_sizes" class="sz_filter">&nbsp;</div>
                        <!-- color filter -->
                        <div id="div_cats" class="ct_filter"></div>
                    </div>
                <?php } ?>

                <div class="productContbox">

                    <?php
                    //$categoryId = Mage::getModel('catalog/layer')->getCurrentCategory()->getId();
                    $categoryId = 42;
                    $shopthecolorCategory = Mage::getModel('catalog/category')->load($categoryId);
                    $shopthecolor_imgUrl = $shopthecolorCategory ->getImageUrl();
                    $productCollection = $shopthecolorCategory->getProductCollection()->addAttributeToFilter('type_id', 'simple')->addAttributeToSelect('*');

                    // check for in sale category
                    /* $categoryIds = json_decode(trim(Mage::getModel('core/variable')->loadByCode('insale_category')->getValue('plain')), true);
                     $showInSaleProduct = true;
                     if ($categoryId == $categoryIds['insale_category_id_women'] || $categoryId == $categoryIds['insale_category_id_mens']) {
                         $showInSaleProduct = true;
                     }*/
                    // end check for in sale category

                    //get color array
                    $write = Mage::getSingleton('core/resource')->getConnection('core_read');
                    $readresult=$write->query("SELECT eaov.value AS 'Attribute', eaov.option_id AS 'Value' FROM eav_attribute ea, eav_attribute_option eao, eav_attribute_option_value eaov WHERE ea.attribute_id = eao.attribute_id AND eao.option_id = eaov.option_id AND eaov.store_id = 0 AND ea.attribute_code='color' ORDER BY eao.sort_order,eaov.value");
                    $colorIndexArr = array();
                    while ($row = $readresult->fetch() ) {
                        $clrinfo[$row['Value']] = $row['Attribute'];
                        $colorIndexArr [] = $row['Value'];
                    }
                    $simpleproductarr = array();
                    $allSkuSizes = array();
                    $allcats = array();
                    $fcolorKey = array();
                    $fcolorValue = array();
                    $i=1;
                    foreach($productCollection as $product)
                    {
                        $filterName = $product->getAttributeText('color_filter');
                        $simpleproductarr['id'] =  $product->getId();
                        $parentIds = Mage::getResourceSingleton('catalog/product_type_configurable')->getParentIdsByChild($simpleproductarr['id']);
                        $simpleproductarr['parentid'] =  $parentIds[0];
                        $simpleproductarr['parentname'] =  Mage::getModel('catalog/product')->load($parentIds[0])->getName();
                        $simpleproductarr['color'] =  $product->getColor();
                        $simpleproductarr['filter_color'] = $product->getColorFilter();
                        $fcolorKey[] = $product->getColorFilter();
                        $fcolorValue[] =$filterName;

                        $simpleproductarr['price'] =  $product->getPrice();
                        $simpleproductarr['insale'] =  $product->getAttributeText('insale');
                        $_gallery = Mage::getModel('catalog/product')->load($parentIds[0])->getMediaGalleryImages();
                        $imageArr = array();
                        $simpleproductarr['image'] = array();
                        foreach($_gallery as $_image)
                        {

                            $imgdata = json_decode(trim($_image->getLabel()), true);

                            $colorId = $imgdata['color'];

                            if($imgdata['type'] == 'ys-listing' && $imgdata['color'] == $simpleproductarr['color'] )
                            {
                                if(count($imageArr[$colorId])<=3)
                                {
                                    array_push($imageArr,$_image->getFile());
                                }
                            }
                            // Grey Background Image.
                            if($imgdata['type'] == 'grey background' && $imgdata['color'] == $simpleproductarr['color'] )
                            {
                                $greyImage  =  $_image->getFile();

                            }


                        }
                        if(end($imageArr)){
                            //end($imageArr);
                            $simpleproductarr['image'][] = end($imageArr) ;
                        }
                        if($imageArr[0]){
                            $simpleproductarr['image'][] =  $imageArr[0];
                        }
                        $confProduct = Mage::getModel('catalog/product')->load($simpleproductarr['parentid']);
                        //show html of the product
                        /**************** size filter *****************/
                        $alphabeticSkuSizes = array();
                        $productColorIndex=0;
                        /**************** size filter *****************/
                        ++$productColorIndex;

                        $confProductForSku = Mage::getModel('catalog/product_type_configurable')->setProduct($confProduct);

                        $skuSizes = array();
                        $simpleCollectionForSku = $confProductForSku->getUsedProductCollection()->addAttributeToSelect('*')->addFieldToFilter(array(array('attribute'=>'color','eq'=>$simpleproductarr['color'])));


                        $characterSizeFound = false;
                        foreach($simpleCollectionForSku as $simpleProductForSku){
                            //$sku = $simpleProductForSku->getId();
                            $filterColorName = $simpleProductForSku->getAttributeText('color');
                            $filterColorName = substr($filterColorName, 0, strpos($filterColorName, "|"));
                            $size = $simpleProductForSku->getAttributeText('size');
                            //$stock = (int)Mage::getModel('cataloginventory/stock_item')->loadByProduct($simpleProductForSku)->getQty();
                            $stock = (int)Mage::getModel('cataloginventory/stock_item')->loadByProduct($simpleProductForSku)->getIsInStock();
                            if(!isset($skuSizes[$filterColorName]))
                                $skuSizes[$filterColorName] = array();

                            if(isset($size) && strlen(trim($size))>0) {
                                $allSkuSizes[] = $size;
                                if ($stock > 0)
                                    $skuSizes[$filterColorName][] = $size;
                            }
                        }
                        /**************** size filter *****************/

                        /****************** size filter **********************************/
                        $productColorName = $clrinfo[$simpleproductarr['color']];
                        $arColorSizes = array();
                        foreach($skuSizes as $keyColor => $sizes) {

                            if ($keyColor == $productColorName) {
                                $strSizes = implode(",", $sizes);
                                break;
                            }
                        }
                        //echo $strSizes;
                        /****************** size filter **********************************/
                        /********************** category filter *********************/
                        $cats = $confProduct->getCategoryIds();
                        $allcats = array_unique(array_merge($allcats,$cats));
                        $catsids = implode(",", $cats);
                        ?>


                        <?php
                        $position = array(Mage::getStoreConfig('product_grid/general/women', Mage::app()->getStore()->getId()));
                        $finalPos = implode(',',$position);

                        if($i == (int)$finalPos[0] || $i == (int)$finalPos[2]):



                            ?>
                            <div class="productCont prodduct_horizontal product-color-<?php echo $productColorIndex;?>" color="<?php echo $simpleproductarr['filter_color']; ?>" rel="<?php echo $strSizes;?>" data="<?php echo $catsids;?>">
                                <div class="prod-img">

                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?>">
                                        <?php
                                        foreach($simpleproductarr['image'] as $img ){?>
                                            <img alt="<?php echo $confProduct->getName();?>" class="prd-image lazy"  data-original="<?php echo $this->helper('catalog/image')->init($confProduct, 'thumbnail',$greyImage)->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(1025,508)->setQuality(91); ?>" />
                                        <?php } ?>
                                    </a>
                                    <a class="clickable"
                                       href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"></a>
                                </div>
                                <div class="caption">
                                    <a class="caption-title" href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"> <?php echo $confProduct->getName()."<br/>"; ?></a>
                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"><span><?php echo $clrinfo[$simpleproductarr['color']]?></span></a>
                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"><span>$<?php echo round($confProduct->getPrice(), 2); ?></span></a>

                                </div>
                            </div>
                        <?php else:?>
                            <div class="productCont product-color-<?php echo $productColorIndex;?>" color="<?php echo $simpleproductarr['filter_color']; ?>" rel="<?php echo $strSizes;?>" data="<?php echo $catsids;?>">
                                <div class="prod-img">

                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?>">
                                        <?php
                                        foreach($simpleproductarr['image'] as $img ){?>
                                            <img alt="<?php echo $confProduct->getName();?>" class="prd-image lazy" data-original="<?php echo $this->helper('catalog/image')->init($confProduct, 'thumbnail',$img)->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(620, 620)->setQuality(91); ?>" />
                                        <?php } ?>
                                    </a>
                                    <a class="clickable"
                                       href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"></a>
                                </div>
                                <div class="caption">
                                    <a class="caption-title" href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"> <?php echo $confProduct->getName()."<br/>"; ?></a>
                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"><span><?php echo $clrinfo[$simpleproductarr['color']]?></span></a>
                                    <a href="<?php echo $confProduct->getProductUrl() . '?color=' . $simpleproductarr['color']; ?><?php echo $hiddenUrl;?>"><span>$<?php echo round($confProduct->getPrice(), 2); ?></span></a>

                                </div>
                            </div>
                        <?php endif;?>

                        <?php $i++;
                    }



                    /************** size filter ***********************/
                    if(isset($allSkuSizes) && count($allSkuSizes)>0)
                        $allSkuSizes = array_unique($allSkuSizes);

                    $arProductAllSizes = array();
                    $attribute = Mage::getModel('eav/config')->getAttribute('catalog_product', 'size'); //here, "color" is the attribute_code
                    $allOptions = $attribute->getSource()->getAllOptions(true, true);
                    foreach ($allOptions as $instance) {
                        if ($instance['label'] != "" && strpos($instance['label'], "T")===false)
                            $arProductAllSizes[] = $instance['label'];
                    }

                    $finalcolorfilter = array_combine($fcolorKey,$fcolorValue);

                    /************** size filter ***********************/

                    ?>
                    <!-- ********************************* checkbox filter ********************** -->
                    <script type="text/javascript">
                        var arAllSizes = Array();
                        var arProductSizes = Array();
                        var arAllCats = Array();
                        var arProductCats = {};//Array();

                        var productColorIndex;

                        productColorIndex = "<?php echo $productColorIndex;?>";

                        <?php
                            foreach($allSkuSizes as $size){
                        ?>
                        arProductSizes.push("<?php echo $size;?>");
                        <?php
                            }
                            foreach($arProductAllSizes as $size){
                        ?>
                        arAllSizes.push("<?php echo $size;?>");
                        <?php
                            }
                        ?>

                        <?php
                        foreach($finalcolorfilter as $id => $name){
                        ?>
                        arProductCats["<?php echo $id;?>"] = "<?php echo $name;?>";
                        <?php
                        }
                        foreach($allcats as $catid){
                        ?>
                        arAllCats.push("<?php echo $catid;?>");
                        <?php
                        }
                        ?>
                        console.log(JSON.stringify(arProductCats));
                        console.log(JSON.stringify(arAllCats));

                    </script>
                    <script src="<?php echo  Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_JS);?>new_jquery/size-filter-new.js"></script>

                    <!-- ********************************* checkbox filter ********************** -->
                </div>
            </div>
            <!-- ProductListing Part -->
            <div class="clear-fix"></div>
            <!-- Feature Product -->

        </div>
        <?php echo $this->getChildHtml('footer'); ?>
    </div>
    <?php echo $this->getChildHtml('before_body_end'); ?>
</div>
</div>
<?php echo $this->getAbsoluteFooter() ?>
</body>
</html>
