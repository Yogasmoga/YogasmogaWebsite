<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Shopping cart template
 *
 * @see Mage_Checkout_Block_Cart
 */
?>
<script type="text/javascript">
//    jQuery(document).ready(function($){
//        $("li#minicartlink").addClass('selected');
//    });
    _oncartpage = true;
</script>
<?php
    //echo Mage::getSingleton('core/session')->getGiftCardActivated().'sdfdsfas';
    //echo "Gift card active= ".Mage::getSingleton('giftcards/session')->getActive()."<br/>";
//    echo "Gift Card balance = ".Mage::helper('giftcards')->getCustomerBalance(Mage::getSingleton('customer/session')->getCustomer()->getId())."<br/>";
//    echo "Smogi buck used = ".Mage::helper('rewardpoints/event')->getCreditPoints()."<br/>";
    
    if(Mage::helper('customer')->isLoggedIn())
    {
        if(!Mage::getSingleton('core/session')->getGiftCardActivated())
        {
            if(Mage::getSingleton('giftcards/session')->getActive() == "0" || Mage::getSingleton('giftcards/session')->getActive() == "")
            {
                Mage::getSingleton('core/session')->setGiftCardActivated('true');
                Mage::getSingleton('giftcards/session')->setActive('1');
                Mage::getSingleton('checkout/cart')->getQuote()->getShippingAddress()->setCollectShippingRates(true);
                Mage::getSingleton('checkout/cart')->getQuote()->collectTotals()->save();
                Mage::app()->getFrontController()->getResponse()->setRedirect(Mage::helper('core/url')->getHomeUrl()."checkout/cart");   
            }
        }   
    }
?>


<link rel="stylesheet" type="text/css" href="<?php echo $this->getSkinUrl('css/cart.css'); ?>" media="all" />
<script type="text/javascript" src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_JS); ?>jquery/myaccount.js"></script>
<div class="cart">
    <div class="myheader">SHOPPING BAG</div>
    <div class="page-title">
        <p class="cart-item">
			<?php $count = $this->helper('checkout/cart')->getSummaryCount();
			$total = $this->helper('checkout/cart')->getQuote()->getGrandTotal();if($count==1){
				echo $this->__('1 ITEM',$count);
			}
			if($count>1){
				echo $this->__('%s ITEMS',$count);
			}
			?>
		</p>
    </div>
    <?php //echo $this->getMessagesBlock()->getGroupedHtml() ?>
    <?php Mage::getSingleton('core/session')->setGlobalMessage($this->getMessagesBlock()->getGroupedHtml()); ?>
    <?php echo $this->getChildHtml('form_before') ?>
    <form action="<?php echo $this->getUrl('checkout/cart/updatePost') ?>" id="bagform" method="post">
        <fieldset>
            <table id="shopping-cart-table" class="data-table cart-table">
                <col width="1" />
                <col width="1" />
                <col />
            <?php //if ($this->helper('wishlist')->isAllowInCart()) : ?>
            <?php if (false) : ?>
                <col width="1" />
            <?php endif ?>
            <?php if ($this->helper('tax')->displayCartPriceExclTax() || $this->helper('tax')->displayCartBothPrices()): ?>
                <col width="1" />
            <?php endif; ?>
            <?php if ($this->helper('tax')->displayCartPriceInclTax() || $this->helper('tax')->displayCartBothPrices()): ?>
                <col width="1" />
            <?php endif; ?>
                <col width="1" />
            <?php if ($this->helper('tax')->displayCartPriceExclTax() || $this->helper('tax')->displayCartBothPrices()): ?>
                <col width="1" />
            <?php endif; ?>
            <?php if ($this->helper('tax')->displayCartPriceInclTax() || $this->helper('tax')->displayCartBothPrices()): ?>
                <col width="1" />
            <?php endif; ?>
                <col width="150" />

            <?php $mergedCells = ($this->helper('tax')->displayCartBothPrices() ? 2 : 1); ?>
                <thead>
                    <tr>
                        <th rowspan="<?php echo $mergedCells; ?>" class="a-center">&nbsp;</th>
                        <th rowspan="<?php echo $mergedCells; ?>"><span class="nobr"><?php echo $this->__('Item') ?></span></th>
                        <th rowspan="<?php echo $mergedCells; ?>">&nbsp;</th>
                        <th rowspan="<?php echo $mergedCells; ?>"></th>
                        <?php //if ($this->helper('wishlist')->isAllowInCart()) : ?>
                        <?php if (false) : ?>
                        <th rowspan="<?php echo $mergedCells; ?>" class="a-center"><span class="nobr"><?php echo $this->__('Move to Wish list') ?></span></th>
                        <?php endif ?>
                        <th class="a-center" colspan="<?php echo $mergedCells; ?>"><span class="nobr"><?php echo $this->__('Price') ?></span></th>
                        <th rowspan="<?php echo $mergedCells; ?>" class="a-center"><?php echo $this->__('Qty') ?></th>
                        <th class="a-right" colspan="<?php echo $mergedCells; ?>"><?php echo $this->__('Subtotal') ?></th>
                    </tr>
                    <?php if ($this->helper('tax')->displayCartBothPrices()): ?>
                    <tr>
                        <th class="a-right"><?php echo $this->helper('tax')->getIncExcTaxLabel(false) ?></th>
                        <th><?php echo $this->helper('tax')->getIncExcTaxLabel(true) ?></th>
                        <th class="a-right"><?php echo $this->helper('tax')->getIncExcTaxLabel(false) ?></th>
                        <th><?php echo $this->helper('tax')->getIncExcTaxLabel(true) ?></th>
                    </tr>
                    <?php endif; ?>
                </thead>
                <tfoot>
                    <tr>
                        <td colspan="50" class="a-right">
                            <?php if($this->getContinueShoppingUrl()): ?>
                                <button type="button" title="<?php echo $this->__('Continue Shopping') ?>" class="button btn-continue" onclick="setLocation('<?php echo $this->getContinueShoppingUrl() ?>')"><span><span><?php echo $this->__('Continue Shopping') ?></span></span></button>
                            <?php endif; ?>
                            <div>
                                <button type="submit" class="button btn-update-bag"><span><span><?php echo $this->__('Update Shopping Cart') ?></span></span></button>
                                <div style="clear: both;"></div>
                            </div>
							<?php //echo $this->getChildHtml('giftcards') ?>
                        </td>
                    </tr>
                </tfoot>
                <tbody>
                <?php foreach($this->getItems() as $_item): ?>
                    <?php echo $this->getItemHtml($_item) ?>
                <?php endforeach ?>
                
                
                <?php
                        $productId = Mage::getModel('core/variable')->loadByCode('namaskar_bracelet_id')->getValue('plain');
                        $quote = Mage::getSingleton('checkout/session')->getQuote();
                        $foundInCart = false;
                        foreach($quote->getAllVisibleItems() as $item) {
                            if ($item->getData('product_id') == $productId) {
                                $foundInCart = true;
                                break;
                            }
                        }
                        if(!$foundInCart)
                        {
                            ?>
                            <script type="text/javascript" src="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_JS); ?>jquery/shoppingbag.js"></script>
                            <?php
                            $_helper = Mage::helper('catalog/output');
                            $_product = Mage::getModel('catalog/product')->load(Mage::getModel('core/variable')->loadByCode('namaskar_bracelet_id')->getValue('plain'));
                            $producturl = $_product->getProductUrl();
                            $productname = $_helper->productAttribute($_product, $_product->getName(), 'name');
                            $productid = $_product->getId();
                            $price = $_product->getSpecialPrice();
                            if($price == "")
                                $price = $_product->getPrice();
                            $price = round($price,2);
                              if (floor($price)==$price)
                                $price = floor($price);
                            $rewardpoints = Mage::helper('rewardpoints/data')->getProductPointsText($_product, false, false);
                            $rewardpoints = strip_tags($rewardpoints);
                            $rewardpoints = trim(substr($rewardpoints, strpos($rewardpoints, "earn") + strlen("earn"), strpos($rewardpoints, "loyalty") - 1 - strlen("loyalty") - strpos($rewardpoints, "earn") + strlen("earn")));
                            $productrewardpoints = $rewardpoints;
                            //$productrewardpoints = floor($price * $_rewardpointsearned);
                            $productprice = "$".$price;
                            
                            $_childproducts = Mage::getModel('catalog/product_type_configurable')->getUsedProducts(null, $_product);
                            $_gallery = Mage::getModel('catalog/product')->load($_product->getId())->getMediaGalleryImages();
                            $productcolorinfo = array();
                            $configurableAttributeCollection=$_product->getTypeInstance()->getConfigurableAttributes();
                            $sizeavaliable = false;
                            foreach($configurableAttributeCollection as $attribute){
                                if($attribute->getProductAttribute()->getAttributeCode() == "size")
                                {
                                    $sizeavaliable = true;
                                    break;
                                }
                                //echo "Attr-Code:".$attribute->getProductAttribute()->getAttributeCode()."<br/>";
                        //        echo "Attr-Label:".$attribute->getProductAttribute()->getFrontend()->getLabel()."<br/>";
                        //        echo "Attr-Id:".$attribute->getProductAttribute()->getId()."<br/>";
                            }
                            foreach($_childproducts as $_childproduct)
                            {
                                //echo Mage::getModel('cataloginventory/stock_item')->loadByProduct($_childproduct)->getQty();
                                $temp = $_childproduct->getAttributeText('color');
                                if(strpos($temp,"|") !== FALSE)
                                {
                                    $hexcodes = substr($temp, strpos($temp,"|") + 1);
                                    $hexcodes = explode(",", $hexcodes);
                                    $temp = substr($temp, 0, strpos($temp,"|"));
                                    if(!isset($productcolorinfo[$temp]))
                                        $productcolorinfo[$temp] = array();
                                    $productcolorinfo[$temp]['hex'] = $hexcodes;
                                    $productcolorinfo[$temp]['value'] = Mage::getResourceModel('catalog/product')->getAttributeRawValue($_childproduct->getId(), 'color', Mage::app()->getStore()->getStoreId());
                                }
                                $price = $_childproduct->getSpecialPrice();
                                if($price == "")
                                    $price = $_childproduct->getPrice();
                                $price = round($price,2);
                                  if (floor($price)==$price)
                                    $price = floor($price);
                                
                                $rewardpoints = Mage::helper('rewardpoints/data')->getProductPointsText($_childproduct, false, false);
                                $rewardpoints = strip_tags($rewardpoints);
                                $rewardpoints = trim(substr($rewardpoints, strpos($rewardpoints, "earn") + strlen("earn"), strpos($rewardpoints, "loyalty") - 1 - strlen("loyalty") - strpos($rewardpoints, "earn") + strlen("earn")));
                                if($sizeavaliable)
                                    $temp1 = $_childproduct->getAttributeText('size')."|".Mage::getModel('cataloginventory/stock_item')->loadByProduct($_childproduct)->getQty()."|".$price."|".$rewardpoints;
                                else
                                    $temp1 = "2|".Mage::getModel('cataloginventory/stock_item')->loadByProduct($_childproduct)->getQty()."|".$price."|".$rewardpoints;
                                //$temp1 = $_childproduct->getAttributeText('size')."|".Mage::getModel('cataloginventory/stock_item')->loadByProduct($_childproduct)->getQty()."|".$price."|".$rewardpoints;
                                //if(array_key_exists("sizes", $productcolorinfo[$temp]))
                                if(isset($productcolorinfo[$temp]["sizes"]))
                                {
                                    //echo "pushing";
                                    array_push($productcolorinfo[$temp]["sizes"], $temp1);
                                }
                                else
                                {
                                    $productcolorinfo[$temp]["sizes"] = array($temp1);
                                    if(!isset($productcolorinfo[$temp]["sizes"]))
                                        echo "not set";    
                                    foreach($_gallery as $_image)
                                    {
                                        if(str_replace("*", "", $_image->getLabel()) == $temp)
                                        {
                                            //echo $imageurl;
                                            $smallimageurl = "_".Mage::helper('catalog/image')->init($_product, 'thumbnail', $_image->getFile())->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(75, 75);
                                            $imageurl = "_".Mage::helper('catalog/image')->init($_product, 'thumbnail', $_image->getFile())->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(450, 450);
                                            $zoomimageurl = "_".Mage::helper('catalog/image')->init($_product, 'thumbnail', $_image->getFile())->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(750, 750);
                                            
                                            //if(count($productcolorinfo[$temp]["images"]) == 0)
                                            if(!isset($productcolorinfo[$temp]["images"]))
                                            {
                                                $productcolorinfo[$temp]["images"] = array();
                                                $productcolorinfo[$temp]["images"]["small"] = array($smallimageurl);
                                                $productcolorinfo[$temp]["images"]["zoom"] = array($zoomimageurl);
                                                $productcolorinfo[$temp]["images"]["big"] = array($imageurl);
                                                //echo "creating"."<br/>";
                                            }
                                            else
                                                if(count($productcolorinfo[$temp]["images"]["small"]) < 4)
                                                {
                                                    array_push($productcolorinfo[$temp]["images"]["big"], $imageurl);
                                                    array_push($productcolorinfo[$temp]["images"]["small"], $smallimageurl);
                                                    //echo "pushing"."<br/>";
                                                    array_push($productcolorinfo[$temp]["images"]["zoom"], $zoomimageurl);
                                                }
                                        }
                                    }
                                }
                            }
                            $tempproductcolorinfo = array();
                            $attribute = Mage::getModel('eav/config')->getAttribute('catalog_product', 'color'); //here, "color" is the attribute_code
                            $allOptions = $attribute->getSource()->getAllOptions(true, true);
                            foreach ($allOptions as $instance) {
                                if(array_key_exists($instance['label'], $productcolorinfo))
                                {
                                    $tempproductcolorinfo[$instance['label']] = $productcolorinfo[$instance['label']];
                                }
                            }
                            $productcolorinfo = $tempproductcolorinfo;
                            
                            
                            $productallsizes = array();
                            
                            
                            $attribute = Mage::getModel('eav/config')->getAttribute('catalog_product', 'size'); //here, "color" is the attribute_code
                            $allOptions = $attribute->getSource()->getAllOptions(true, true);
                            foreach ($allOptions as $instance) {
                                if($instance['label'] != "")
                                    array_push($productallsizes, array("label" => $instance['label'], "value" => $instance['value']) );
                            }
                            ?>
                                <tr class="nohover">
                                   <td style="border-top : 1px dotted #000000;" colspan="7">
                                   <script type="text/javascript">
                                        _productcolorinfo = new Array();
                                    <?php
                                    $configurableAttributeCollection=$_product->getTypeInstance()->getConfigurableAttributes();
                                    foreach($configurableAttributeCollection as $attribute){
                                        //echo "Attr-Code:".$attribute->getProductAttribute()->getAttributeCode()."<br/>";
                                //        echo "Attr-Label:".$attribute->getProductAttribute()->getFrontend()->getLabel()."<br/>";
                                //        echo "Attr-Id:".$attribute->getProductAttribute()->getId()."<br/>";
                                        ?>
                                        _productid = '<?php echo $productid; ?>';
                                        <?php
                                        if($attribute->getProductAttribute()->getAttributeCode() == "color")
                                        {
                                            ?>
                                                _colorattributeid = '<?php echo $attribute->getProductAttribute()->getId(); ?>';
                                            <?php       
                                        }
                                        if($attribute->getProductAttribute()->getAttributeCode() == "size")
                                        {
                                            ?>
                                                _sizeattributeid = '<?php echo $attribute->getProductAttribute()->getId(); ?>';
                                            <?php       
                                        }
                                    }
                                    
                                    $currentcolorcount = 0;
                                    foreach($productcolorinfo as $key=>$val)
                                    {
                                        ?>
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>] = new Object();
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].color = '<?php echo $key; ?>'; 
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].hex = new Array();
                                            <?php
                                                for($i = 0; $i < count($val['hex']); $i++)
                                                {
                                                    ?>
                                                        _productcolorinfo[<?php echo $currentcolorcount; ?>].hex[<?php echo $i; ?>] = '<?php echo $val['hex'][$i]; ?>';
                                                    <?php
                                                } 
                                            ?>
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].sizes = new Array();
                                            <?php
                                                for($i = 0; $i < count($val['sizes']); $i++)
                                                {
                                                    ?>
                                                        _productcolorinfo[<?php echo $currentcolorcount; ?>].sizes[<?php echo $i; ?>] = '<?php echo $val['sizes'][$i]; ?>';
                                                    <?php
                                                } 
                                            ?>
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].zoomimages = new Array();
                                            <?php
                                                for($i = 0; $i < count($val['images']['zoom']); $i++)
                                                {
                                                    ?>
                                                        _productcolorinfo[<?php echo $currentcolorcount; ?>].zoomimages[<?php echo $i; ?>] = '<?php echo substr($val['images']['zoom'][$i], 1); ?>';
                                                    <?php
                                                } 
                                            ?>
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].smallimages = new Array();
                                            <?php
                                                for($i = 0; $i < count($val['images']['small']); $i++)
                                                {
                                                    ?>
                                                        _productcolorinfo[<?php echo $currentcolorcount; ?>].smallimages[<?php echo $i; ?>] = '<?php echo substr($val['images']['small'][$i], 1); ?>';
                                                    <?php
                                                } 
                                            ?>
                                            _productcolorinfo[<?php echo $currentcolorcount; ?>].bigimages = new Array();
                                            <?php
                                                for($i = 0; $i < count($val['images']['big']); $i++)
                                                {
                                                    ?>
                                                        _productcolorinfo[<?php echo $currentcolorcount; ?>].bigimages[<?php echo $i; ?>] = '<?php echo substr($val['images']['big'][$i], 1); ?>';
                                                    <?php
                                                } 
                                            ?>
                                        <?php
                                                $currentcolorcount++;
                                            }  
                                        ?>
                                        //_productdisplaymode = 'popup';
                                        //console.log(_productcolorinfo);
                                    </script>
                                    <?php
                                        if(!$sizeavaliable)
                                        {
                                            ?>
                                                <script type="text/javascript">
                                                    _sizesuperattribute = false;
                                                </script>
                                            <?php
                                        }
                                    ?>
                                    <div class="page-title" style="margin-bottom: 7px;">
                                        <h1 class="checkout-namaskar-header">HELP THE NAMASK&Aacute;R FOUNDATION: ADD THIS BRACELET TO YOUR ORDER</h1>
                                    </div>
                                   </td>
                                </tr>
                                <tr class="nohover">
                                    <td>&nbsp;</td>
                                    <td>
                                        <img src="<?php echo Mage::helper('catalog/image')->init($_product, 'image')->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(75, 75); ?>" width="75" height="75" alt="<?php echo $productname; ?>" />
                                    </td>
                                    <td colspan="<?php if ($this->helper('wishlist')->isAllowInCart()) { echo "2"; } else { echo "2"; } ?>">
                                        <h2 class="product-name">
                                            <a href="<?php echo $producturl; ?>"><?php echo $productname; ?></a>
                                        </h2>
                                        <dl class="item-options">
                                            <dt>COLOR:</dt>
                                			<dd>
                                                <span id="spncolor">
                                                    
                                                </span>
                                                <select id="cmbcolor">
                                                    <?php
                                                         foreach($productcolorinfo as $key=>$colorinfo)
                                                        {
                                                            ?>
                                                                <option value="<?php echo $colorinfo['value']; ?>"><?php echo $key; ?></option>  
                                                            <?php
                                                        }
                                                    ?>
                                                </select>
                                            </dd>
                                            <dt  <?php if(!$sizeavaliable) { echo "style='display:none;'"; } ?>>SIZE:</dt>
                                			<dd <?php if(!$sizeavaliable) { echo "style='display:none;'"; } ?>>
                                                <span id="spnsize"></span>
                                                <select id="cmbsize" class="cmbsize">
                                                    <?php
                                                        foreach($productallsizes as $size)
                                                        {
                                                            ?>
                                                                <option value="<?php echo $size['value']; ?>" size="<?php echo $size['label']; ?>"><?php echo $size['label']; ?></option>        
                                                            <?php
                                                        } 
                                                    ?>   
                                                </select>
                                            </dd>
                                        </dl>
                                    </td>
                                    <td class="a-right">
                                        <span class="cart-price">
                                            <span id="spnbaseprice" class="price">$<?php echo $price; ?></span>                
                                        </span>
                                    </td>
                                    <td class="a-center">
                                        <input id="braceletcount" maxlength="12" class="input-text qty" title="Qty" size="4" value="0" name="cart[365][qty]" />
                                    </td>
                                    <td class="a-right last">
                                        <span class="cart-price">
                                            <span id="spntotalprice" class="price">$0.00</span>                            
                                        </span>
                                    </td>
                                </tr>
                            <?php
                        } 
                    ?>
                </tbody>
            </table>
            <?php echo $this->getChildHtml('giftcards') ?>      
            <script type="text/javascript">decorateTable('shopping-cart-table')</script>
        </fieldset>
    </form>
    <div class="cart-collaterals">
		<div class="smogi-bucks"><?php echo $this->getChildHtml('coupon') ?></div>
        <!-- div class="col2-set">
            <div class="col-1">
                <?php echo $this->getChildHtml('crosssell') ?>
            </div>
            <div class="col-2">
                
                <?php // if (!$this->getIsVirtual()): echo $this->getChildHtml('shipping'); endif; ?>
            </div>
        </div -->
        <div class="totals">
            <?php echo $this->getChildHtml('totals'); ?>
            <?php if(!$this->hasError()): ?>
            <ul class="checkout-types">
            <?php foreach ($this->getMethods('methods') as $method): ?>
                <?php if ($methodHtml = $this->getMethodHtml($method)): ?>
                <li><?php echo $methodHtml; ?></li>
                <?php endif; ?>
            <?php endforeach; ?>
            </ul>
            <?php endif; ?>
        </div>
		<div class="clearer"></div>
    </div>
</div>